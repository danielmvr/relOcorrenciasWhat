<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formul√°rio de Socorros v2.3</title>
  <style>
    :root{
      --primary:#42426F;
      --primary-hover:#303050;
      --danger:#f44336;
      --warning:#ff9800;
      --copy-done:#9ec6b8;
      --text:#222;
      --muted:#666;
    }
    body{
      font-family: Arial, sans-serif;
      color: var(--text);
      margin: 0;
      background: linear-gradient(135deg, #6B87C2 70%, #F8C01A 20%, #831D34 10%) fixed bottom center / cover no-repeat;
    }
    .container{
      display:flex;
      gap:24px;
      max-width: 1000px;
      margin: 24px auto;
      background-color: rgba(255,255,255,0.55);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      backdrop-filter: blur(3px);
    }
    form{ flex:1; min-width: 300px; }
    .report-container{ flex:1; min-width: 300px; }

    h2{ color: var(--primary); margin: 0 0 12px; }

    label{
      display:block;
      margin: 10px 0 6px;
      color: var(--primary);
      font-weight: 600;
    }
    input[type="text"], input[type="number"], input[type="date"], input[type="time"], textarea, select{
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #f5f5f5;
      transition: border-color .2s ease;
      font-size: 14px;
      box-sizing: border-box;
    }
    input:focus, textarea:focus, select:focus{
      outline: none; border-color: var(--primary); background-color: #fff;
    }
    textarea{ min-height: 80px; resize: vertical; }

    .row{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row-3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }

    .radio-group{ display:flex; gap: 12px; align-items:center; }
    .radio-item{ display:flex; gap:6px; align-items:center; }

    .actions{ display:flex; flex-wrap:wrap; gap:8px; margin-top: 10px; }
    .btn{
      display:inline-block; padding:10px 16px; border:none; border-radius:8px;
      color:#fff; background:var(--primary); cursor:pointer;
      transition: transform .04s ease, filter .2s ease, background-color .2s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ background:var(--primary); }
    .btn-primary:hover{ background:var(--primary-hover); }
    .btn-warning{ background:var(--warning); }
    .btn-warning:hover{ filter:brightness(.95); }
    .btn-danger{ background:var(--danger); }
    .btn-danger:hover{ filter:brightness(.95); }
    .btn-copy{ background:var(--primary); }
    .btn-copy:hover{ filter:brightness(.95); }
    .btn-copy.copied{ background: var(--copy-done); color:#083b2e; }

    .report-entry{
      background:#fff; border:1px solid #e6e6e6; border-radius:10px;
      padding:12px 12px 10px; margin-bottom:12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }
    .report-entry p{ margin:6px 0; font-size:14px; line-height:1.35; word-break: break-word; }
    .report-entry strong{ font-weight:700; }

    .empty-state{
      text-align:center; color: var(--muted); padding:16px;
      border:1px dashed #bbb; border-radius:8px; background:#fafafa;
    }
    .toolbar{ display:flex; gap:8px; margin-top:10px; justify-content:flex-end; }

    @media (max-width: 900px){
      .container{ flex-direction:column; }
      .row, .row-3{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <form id="socorroForm" autocomplete="off" novalidate>
      <h2>Cadastro de Socorro</h2>

      <label for="dataSocorro">Data do Socorro:</label>
      <input id="dataSocorro" type="date" name="dataSocorro" required>

      <div class="row">
        <div>
          <label for="carro">Carro <small>(Ex.: 11216.U)</small>:</label>
          <input id="carro" type="text" name="carro" list="carrosList" placeholder="11216.U" required>
          <datalist id="carrosList">
            <option value="11216.U"></option>
            <option value="11202.U"></option>
            <option value="11001.U"></option>
          </datalist>
        </div>
        <div>
          <label for="carroSegue">Carro que segue <small>(Ex.: 11202.U)</small>:</label>
          <input id="carroSegue" type="text" name="carroSegue" list="carrosList" placeholder="11202.U">
        </div>
      </div>

      <div class="row">
        <div>
          <label for="motorista">Motorista:</label>
          <input id="motorista" type="text" name="motorista" required>
        </div>
        <div>
          <label for="matricula">Mat:</label>
          <input id="matricula" type="text" name="matricula" placeholder="Matr√≠cula">
        </div>
      </div>

      <div class="row">
        <div>
          <label for="dataViagem">Data da viagem:</label>
          <input id="dataViagem" type="date" name="dataViagem">
        </div>
        <div>
          <label for="horarioViagem">Hor√°rio da viagem:</label>
          <input id="horarioViagem" type="time" name="horarioViagem">
        </div>
      </div>

      <div class="row">
        <div>
          <label for="qtdClientes">Qtd. clientes:</label>
          <input id="qtdClientes" type="number" name="qtdClientes" min="0" step="1" placeholder="0">
        </div>
        <div>
          <label>Encomendas:</label>
          <div class="radio-group" role="radiogroup" aria-label="Encomendas">
            <label class="radio-item">
              <input type="radio" name="encomendas" value="Sim"> <span>Sim</span>
            </label>
            <label class="radio-item">
              <input type="radio" name="encomendas" value="N√£o" checked> <span>N√£o</span>
            </label>
          </div>
        </div>
      </div>

      <label for="linha">Linha <small>(Ex.: RIOxCGB)</small>:</label>
      <input id="linha" type="text" name="linha" placeholder="RIOxCGB">

      <div class="row">
        <div>
          <label for="inicioSocorro">In√≠cio do Socorro:</label>
          <input id="inicioSocorro" type="time" name="inicioSocorro">
        </div>
        <div>
          <label for="fimSocorro">Fim do socorro:</label>
          <input id="fimSocorro" type="time" name="fimSocorro">
        </div>
      </div>

      <label for="localSocorro">Local do Socorro:</label>
      <input id="localSocorro" type="text" name="localSocorro" placeholder="Ex.: Av. Brasil, KM 120">

      <label for="defeitoMotorista">Defeito passado pelo motorista:</label>
      <textarea id="defeitoMotorista" name="defeitoMotorista" placeholder="Descreva o relato do motorista..."></textarea>

      <label for="responsavelManutencao">Respons√°vel da Manuten√ß√£o acionado:</label>
      <input id="responsavelManutencao" type="text" name="responsavelManutencao" placeholder="Nome do respons√°vel">

      <label for="saidaSocorro">Local e hor√°rio da sa√≠da do socorro <small>(Ex.: RIO - 08:52)</small>:</label>
      <input id="saidaSocorro" type="text" name="saidaSocorro" placeholder="RIO - 08:52">

      <label for="obs">Obs :</label>
      <textarea id="obs" name="obs" placeholder="Observa√ß√µes adicionais..."></textarea>

      <label for="coordenador">Coordenador:</label>
      <input id="coordenador" type="text" name="coordenador">

      <div class="actions">
        <button type="submit" class="btn btn-primary">Salvar</button>
        <button id="resetButton" type="reset" class="btn btn-warning">Limpar Formul√°rio</button>
      </div>
    </form>

    <div class="report-container">
      <h2>Registros</h2>
      <div id="report"></div>

      <div class="toolbar">
        <button id="exportCSV" class="btn btn-primary" title="Exportar todas em CSV">Exportar CSV</button>
        <button id="exportJSON" class="btn btn-primary" title="Exportar todas em JSON">Exportar JSON</button>
        <button id="clearAll" class="btn btn-danger" title="Apagar todos os registros">Limpar Registros</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("socorroForm");
      const reportDiv = document.getElementById("report");
      const exportCSVBtn = document.getElementById("exportCSV");
      const exportJSONBtn = document.getElementById("exportJSON");
      const clearAllBtn = document.getElementById("clearAll");

      // ---- Storage robusto ----
      function loadData(){
        try{
          const raw = localStorage.getItem("socorrosV2");
          const arr = raw ? JSON.parse(raw) : [];
          return Array.isArray(arr) ? arr : [];
        }catch{ return []; }
      }
      function saveData(arr){
        localStorage.setItem("socorrosV2", JSON.stringify(arr));
      }

      // ---- Util ----
      function uid(){ return `${Date.now()}_${Math.random().toString(36).slice(2,8)}`; }

      function formatBRDate(dateStr){
        if(!dateStr) return "";
        const [y,m,d] = dateStr.split("-");
        return `${d}/${m}/${y.slice(2)}`; // dd/mm/aa
      }
      function makeTs(dateStr, timeStr){
        if(!dateStr && !timeStr) return 0;
        const iso = `${dateStr || "1970-01-01"}T${timeStr || "00:00"}:00`;
        const ms = Date.parse(iso);
        return Number.isNaN(ms) ? 0 : ms;
      }

      function getField(el){ return (el?.value ?? "").trim(); }

      function extractFormData(formEl){
        const data = {};
        const fields = formEl.querySelectorAll("input, textarea, select");
        fields.forEach(f => {
          if(f.type === "radio"){
            if(f.checked){ data[f.name] = f.value; }
          } else {
            data[f.name] = getField(f);
          }
        });
        return data;
      }

      function clearForm(formEl){ formEl.reset(); }

      function line(label, value){
        const p = document.createElement("p");
        const strong = document.createElement("strong");
        strong.textContent = label + " ";
        const span = document.createElement("span");
        span.textContent = value ?? "";
        p.appendChild(strong);
        p.appendChild(span);
        return p;
      }

      // >>> ALTERA√á√ÉO: c√≥pia para WhatsApp com √≠cones e negrito do "Carro"
      async function copyEntryAsText(item, btn){
        const lines = [
          `üìÖ Data do Socorro: ${formatBRDate(item.dataSocorro)}`,
          `üöç Carro: *${item.carro}*`,
          `üë§ Motorista: ${item.motorista}`,
          `ü™™ Mat: ${item.matricula}`,
          `üóìÔ∏è Data da viagem: ${formatBRDate(item.dataViagem)}`,
          `‚è∞ Hor√°rio da viagem: ${item.horarioViagem}`,
          `üë• Qtd. clientes: ${item.qtdClientes}`,
          `üì¶ Encomendas: ${item.encomendas || ""}`,
          `üß≠ Linha: ${item.linha}`,
          `‚è±Ô∏è In√≠cio do Socorro: ${item.inicioSocorro}`,
          `üìç Local do Socorro: ${item.localSocorro}`,
          `üõ†Ô∏è Defeito passado pelo motorista: ${item.defeitoMotorista}`,
          `üß∞ Respons√°vel da Manuten√ß√£o acionado: ${item.responsavelManutencao}`,
          `üöêüí® Sa√≠da do socorro: ${item.saidaSocorro}`,
          `‚úÖ Fim do socorro: ${item.fimSocorro}`,
          `‚û°Ô∏è Carro que segue: ${item.carroSegue}`,
          `üìù Obs: ${item.obs}`,
          `üßë‚Äçüíº Coordenador: ${item.coordenador}`,
          ``
        ];
        await navigator.clipboard.writeText(lines.join("\n"));
        if(btn){
          const old = btn.textContent;
          btn.classList.add("copied");
          btn.textContent = "Copiado!";
          setTimeout(()=>{ btn.classList.remove("copied"); btn.textContent = old; }, 1800);
        }
      }
      // <<< FIM DA ALTERA√á√ÉO

      function updateReport(arr){
        reportDiv.innerHTML = "";
        if(!arr.length){
          const empty = document.createElement("div");
          empty.className = "empty-state";
          empty.textContent = "Nenhum registro ainda.";
          reportDiv.appendChild(empty);
          return;
        }

        // Ordenar por Data do Socorro + In√≠cio do Socorro (mais recentes primeiro)
        const sorted = [...arr].sort((a,b) => {
          const ta = makeTs(a.dataSocorro, a.inicioSocorro || a.horarioViagem || a.fimSocorro);
          const tb = makeTs(b.dataSocorro, b.inicioSocorro || b.horarioViagem || b.fimSocorro);
          return tb - ta;
        });

        sorted.forEach(item => {
          const entry = document.createElement("div");
          entry.className = "report-entry";

          entry.appendChild(line("Data do Socorro:", formatBRDate(item.dataSocorro)));
          entry.appendChild(line("Carro:", item.carro));
          entry.appendChild(line("Motorista:", item.motorista));
          entry.appendChild(line("Mat:", item.matricula));
          entry.appendChild(line("Data da viagem:", formatBRDate(item.dataViagem)));
          entry.appendChild(line("Hor√°rio da viagem:", item.horarioViagem));
          entry.appendChild(line("Qtd. clientes:", item.qtdClientes));
          entry.appendChild(line("Encomendas:", item.encomendas));
          entry.appendChild(line("Linha:", item.linha));
          entry.appendChild(line("In√≠cio do Socorro:", item.inicioSocorro));
          entry.appendChild(line("Local do Socorro:", item.localSocorro));
          entry.appendChild(line("Defeito passado pelo motorista:", item.defeitoMotorista));
          entry.appendChild(line("Respons√°vel da Manuten√ß√£o acionado:", item.responsavelManutencao));
          entry.appendChild(line("Sa√≠da do socorro:", item.saidaSocorro));
          entry.appendChild(line("Fim do socorro:", item.fimSocorro));
          entry.appendChild(line("Carro que segue:", item.carroSegue));
          entry.appendChild(line("Obs:", item.obs));
          entry.appendChild(line("Coordenador:", item.coordenador));

          const actions = document.createElement("div");
          actions.className = "actions";

          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "btn btn-warning";
          editBtn.textContent = "Editar";
          editBtn.addEventListener("click", () => editItem(item.id));

          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "btn btn-danger";
          delBtn.textContent = "Excluir";
          delBtn.addEventListener("click", () => deleteItem(item.id));

          const copyBtn = document.createElement("button");
          copyBtn.type = "button";
          copyBtn.className = "btn btn-copy";
          copyBtn.textContent = "Copiar";
          copyBtn.addEventListener("click", () => copyEntryAsText(item, copyBtn));

          actions.appendChild(editBtn);
          actions.appendChild(delBtn);
          actions.appendChild(copyBtn);
          entry.appendChild(actions);

          reportDiv.appendChild(entry);
        });
      }

      function saveItem(data){
        const arr = loadData();
        arr.push({ id: uid(), ...data });
        saveData(arr);
        updateReport(arr);
      }

      function editItem(id){
        const arr = loadData();
        const item = arr.find(x => x.id === id);
        if(!item) return;

        // Preenche o formul√°rio
        Object.keys(item).forEach(k => {
          if(k === "id") return;
          const el = form.elements[k];
          if(!el) return;
          if(el.type === "radio"){
            const radios = form.querySelectorAll(`input[name="${k}"]`);
            radios.forEach(r => r.checked = (r.value === item[k]));
          }else{
            el.value = item[k] || "";
          }
        });

        // Remove o item editado da base para regravar ao salvar
        const next = arr.filter(x => x.id !== id);
        saveData(next);
        updateReport(next);
      }

      function deleteItem(id){
        if(!confirm("Excluir este registro?")) return;
        const arr = loadData().filter(x => x.id !== id);
        saveData(arr);
        updateReport(arr);
      }

      function clearAll(){
        if(!confirm("Tem certeza que deseja remover todos os registros?")) return;
        localStorage.removeItem("socorrosV2");
        updateReport([]);
      }

      // ---- Exporta√ß√µes ----
      const CSV_HEADERS = [
        "dataSocorro","carro","motorista","matricula","dataViagem","horarioViagem",
        "qtdClientes","encomendas","linha","inicioSocorro","localSocorro",
        "defeitoMotorista","responsavelManutencao","saidaSocorro","fimSocorro",
        "carroSegue","obs","coordenador","id"
      ];

      function exportJSON(){
        const arr = loadData();
        const blob = new Blob([JSON.stringify(arr, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        download(url, `socorros_${new Date().toISOString().slice(0,10)}.json`);
      }

      function exportCSV(){
        const arr = loadData();
        if(!arr.length){ alert("N√£o h√° dados para exportar."); return; }

        const escapeCSV = (val="") => {
          const v = String(val).replace(/"/g,'""');
          return /[",\n;]/.test(v) ? `"${v}"` : v;
        };

        const lines = [];
        lines.push(CSV_HEADERS.join(";"));
        for(const o of arr){
          const row = CSV_HEADERS.map(h => {
            if(h === "dataSocorro" || h === "dataViagem"){
              return escapeCSV(formatBRDate(o[h] ?? ""));
            }
            return escapeCSV(o[h] ?? "");
          }).join(";");
          lines.push(row);
        }

        const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
        const url = URL.createObjectURL(blob);
        download(url, `socorros_${new Date().toISOString().slice(0,10)}.csv`);
      }

      function download(url, filename){
        const a = document.createElement("a");
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click();
        a.remove(); URL.revokeObjectURL(url);
      }

      // ---- Eventos ----
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const data = extractFormData(form);
        saveItem(data);
        clearForm(form);
      });

      exportCSVBtn.addEventListener("click", (e) => { e.preventDefault(); exportCSV(); });
      exportJSONBtn.addEventListener("click", (e) => { e.preventDefault(); exportJSON(); });
      clearAllBtn.addEventListener("click", (e) => { e.preventDefault(); clearAll(); });

      // Inicializa√ß√£o
      updateReport(loadData());
    });
  </script>
</body>
</html>
